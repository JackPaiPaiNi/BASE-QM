/**
 *
 * 信息管理部软件开发科Bootstrap插件系列
 * 
 * jquery.sky.autocomplete 基于bootstrap3-typeahead源码修改
 *
 * 王歌 2016年11月
 */
(function(b,h){"undefined"!==typeof module&&module.exports?module.exports=h(require("jquery")):"function"===typeof define&&define.amd?define(["jquery"],function(a){return h(a)}):h(b.jQuery)})(this,function(b){var h=function(a,d){this.$element=b(a);this.options=b.extend({},b.fn.skyAutoComplete.defaults,d);this.matcher=this.options.matcher||this.matcher;this.sorter=this.options.sorter||this.sorter;this.select=this.options.select||this.select;this.autoSelect="boolean"==typeof this.options.autoSelect?
this.options.autoSelect:!0;this.highlighter=this.options.highlighter||this.highlighter;this.render=this.options.render||this.render;this.updater=this.options.updater||this.updater;this.displayText=this.options.displayText||this.displayText;this.text=this.options.text||this.text;this.data=this.options.data;this.delay=this.options.delay;this.$menu=b(this.options.menu);this.$appendTo=this.options.appendTo?b(this.options.appendTo):null;this.fitToElement="boolean"==typeof this.options.fitToElement?
this.options.fitToElement:!1;this.shown=!1;this.listen();this.showHintOnFocus="boolean"==typeof this.options.showHintOnFocus||"all"===this.options.showHintOnFocus?this.options.showHintOnFocus:!1;this.afterSelect=this.options.afterSelect;this.addItem=!1;this.value=this.$element.val()||this.$element.text()};h.prototype={constructor:h,select:function(){var a=this.$menu.find(".active").data("data");this.$element.data("active",a);if(this.autoSelect||a)a=this.updater(a)||{},this.$element.val(a[this.text]).text(a[this.text]).change(),
this.afterSelect(a);return this.hide()},updater:function(a){return a},setSource:function(a){this.data=a},show:function(){var a=b.extend({},this.$element.position(),{height:this.$element[0].offsetHeight}),d="function"==typeof this.options.scrollHeight?this.options.scrollHeight.call():this.options.scrollHeight,c;this.shown?c=this.$menu:this.$appendTo?(c=this.$menu.appendTo(this.$appendTo),this.hasSameParent=this.$appendTo.is(this.$element.parent())):(c=this.$menu.insertAfter(this.$element),this.hasSameParent=
!0);if(!this.hasSameParent){c.css("position","fixed");var g=this.$element.offset();a.top=g.top;a.left=g.left}d=b(c).parent().hasClass("dropup")?"auto":a.top+a.height+d;a=b(c).hasClass("dropdown-menu-right")?"auto":a.left;c.css({top:d,left:a}).show();!0===this.options.fitToElement&&c.css("width",this.$element.outerWidth()+"px");this.shown=!0;return this},hide:function(){this.$menu.hide();this.shown=!1;return this},lookup:function(a){this.query="undefined"!=typeof a&&null!==a?a:this.$element.val()||
this.$element.text()||"";if(this.query.length<this.options.minLength&&!this.options.showHintOnFocus)return this.shown?this.hide():this;a=b.proxy(function(){b.isFunction(this.data)?this.data(this.query,b.proxy(this.process,this)):this.data&&this.process(this.data)},this);clearTimeout(this.lookupWorker);this.lookupWorker=setTimeout(a,this.delay)},process:function(a){var d=this;a=b.grep(a,function(a){return d.matcher(a)});a=this.sorter(a);if(!a.length&&!this.options.addItem)return this.shown?
this.hide():this;0<a.length?this.$element.data("active",a[0]):this.$element.data("active",null);this.options.addItem&&a.push(this.options.addItem);return"all"==this.options.items?this.render(a).show():this.render(a.slice(0,this.options.items)).show()},matcher:function(a){var d="",c=this.displayText;b.each(c,function(b,e){d+=a[e];b+1!=c.length&&(d+="|")});return~d.toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(a){for(var d=[],c=[],g=[],e;e=a.shift();){var f="",k=this.displayText;
b.each(k,function(a,b){f+=e[b];a+1!=k.length&&(f+="|")});f.toLowerCase().indexOf(this.query.toLowerCase())?~f.indexOf(this.query)?c.push(e):g.push(e):d.push(e)}return d.concat(c,g)},highlighter:function(a,d){var c="",g=this.displayText;b.each(g,function(a,b){c+=d[b];a+1!=g.length&&(c+="|")});var e=b("<div></div>"),f=this.query,k=c.toLowerCase().indexOf(f.toLowerCase()),m=f.length,h,l;if(0===m)return e.text(c).html();for(;-1<k;)h=c.substr(0,k),l=c.substr(k,m),k=c.substr(k+m),l=b("<strong></strong>").text(l),
e.append(document.createTextNode(h)).append(l),c=k,k=c.toLowerCase().indexOf(f.toLowerCase());return e.append(document.createTextNode(c)).html()},render:function(a){var d=this,c=this,g=!1,e=[],f=d.options.separator;b.each(a,function(b,c){0<b&&c[f]!==a[b-1][f]&&e.push({__type:"divider"});!c[f]||0!==b&&c[f]===a[b-1][f]||e.push({__type:"category",name:c[f]});e.push(c)});a=b(e).map(function(a,e){if("category"==(e.__type||!1))return b(d.options.headerHtml).text(e.name)[0];if("divider"==(e.__type||!1))return b(d.options.headerDivider)[0];
var f=c.text;a=b(d.options.item).data("data",e);a.find("a").html(d.highlighter(f,e));f==c.$element.val()&&(a.addClass("active"),c.$element.data("active",e),g=!0);return a[0]});this.autoSelect&&!g&&(a.filter(":not(.dropdown-header)").first().addClass("active"),this.$element.data("active",a.first().data("data")));this.$menu.html(a);return this},displayText:[],next:function(a){a=this.$menu.find(".active").removeClass("active").next();a.length||(a=b(this.$menu.find("li")[0]));a.addClass("active")},prev:function(a){a=
this.$menu.find(".active").removeClass("active").prev();a.length||(a=this.$menu.find("li").last());a.addClass("active")},listen:function(){this.$element.on("focus",b.proxy(this.focus,this)).on("blur",b.proxy(this.blur,this)).on("keypress",b.proxy(this.keypress,this)).on("input",b.proxy(this.input,this)).on("keyup",b.proxy(this.keyup,this));if(this.eventSupported("keydown"))this.$element.on("keydown",b.proxy(this.keydown,this));this.$menu.on("click",b.proxy(this.click,this)).on("mouseenter","li",b.proxy(this.mouseenter,
this)).on("mouseleave","li",b.proxy(this.mouseleave,this)).on("mousedown",b.proxy(this.mousedown,this))},destroy:function(){this.$element.data("skyAutoComplete",null);this.$element.data("active",null);this.$element.off("focus").off("blur").off("keypress").off("input").off("keyup");this.eventSupported("keydown")&&this.$element.off("keydown");this.$menu.remove();this.destroyed=!0},eventSupported:function(a){var b=a in this.$element;b||(this.$element.setAttribute(a,"return;"),b="function"===typeof this.$element[a]);
return b},move:function(a){if(this.shown)switch(a.keyCode){case 9:case 13:case 27:a.preventDefault();break;case 38:if(a.shiftKey)break;a.preventDefault();this.prev();break;case 40:if(a.shiftKey)break;a.preventDefault();this.next()}},keydown:function(a){this.suppressKeyPressRepeat=~b.inArray(a.keyCode,[40,38,9,13,27]);this.shown||40!=a.keyCode?this.move(a):this.lookup()},keypress:function(a){this.suppressKeyPressRepeat||this.move(a)},input:function(a){a=this.$element.val()||this.$element.text();this.value!==
a&&(this.value=a,this.lookup())},keyup:function(a){if(!this.destroyed)switch(a.keyCode){case 9:case 13:if(!this.shown)break;this.select();break;case 27:if(!this.shown)break;this.hide()}},focus:function(a){this.focused||(this.focused=!0,this.options.showHintOnFocus&&!0!==this.skipShowHintOnFocus&&("all"===this.options.showHintOnFocus?this.lookup(""):this.lookup()));this.skipShowHintOnFocus&&(this.skipShowHintOnFocus=!1)},blur:function(a){this.mousedover||this.mouseddown||!this.shown?this.mouseddown&&
(this.skipShowHintOnFocus=!0,this.$element.focus(),this.mouseddown=!1):(this.hide(),this.focused=!1)},click:function(a){a.preventDefault();this.skipShowHintOnFocus=!0;this.select();this.$element.focus();this.hide()},mouseenter:function(a){this.mousedover=!0;this.$menu.find(".active").removeClass("active");b(a.currentTarget).addClass("active")},mouseleave:function(a){this.mousedover=!1;!this.focused&&this.shown&&this.hide()},mousedown:function(a){this.mouseddown=!0;this.$menu.one("mouseup",function(a){this.mouseddown=
!1}.bind(this))}};b.fn.skyAutoComplete=function(a){var d=arguments;return"string"==typeof a&&"getActive"==a?this.data("active"):this.each(function(){var c=b(this),g=c.data("skyAutoComplete"),e="object"==typeof a&&a;g||c.data("skyAutoComplete",g=new h(this,e));if("string"==typeof a&&g[a])if(1<d.length)g[a].apply(g,Array.prototype.slice.call(d,1));else g[a]()})};b.fn.skyAutoComplete.defaults={data:[],items:8,menu:'<ul class="skyAutoComplete dropdown-menu" role="listbox"></ul>',item:'<li><a class="dropdown-item" href="#" role="option"></a></li>',
minLength:1,scrollHeight:0,autoSelect:!0,afterSelect:b.noop,addItem:!1,delay:0,separator:"category",headerHtml:'<li class="dropdown-header"></li>',headerDivider:'<li class="divider" role="separator"></li>'};b(document).on("focus.skyAutoComplete.data-api",'[data-provide="skyAutoComplete"]',function(a){a=b(this);a.data("skyAutoComplete")||a.skyAutoComplete(a.data())})});