/**
 * 
 * 信息管理部软件开发科jQuery插件系列
 * 
 * jquery.sky.form from组件
 * 
 * ecportExcel 根据sky.jqgrid导出Excel
 * 
 * skyDate 基于myDate97
 * 
 * getLocalCache,clearAllCache,isSupportCache浏览器本地缓存
 * 
 * numToRMB 人民表小写转大写
 *
 * 王歌 2016年11月
 */
jQuery.fn.extend({getFormData:function(){var a=$(this);a.removeDisabled();var d=a.serializeArray();a.addDisabled();var b={};$.each(d,function(a,c){c.name&&("undefined"==typeof b[c.name]?b[c.name]=c.value:""!=c.value&&(b[c.name]+=","+c.value))});return b},setFormData:function(a){var d=$(this);d.find(".skycheckbox").prop("checked","checked");var b=d.getFormData();d.find(".skycheckbox").removeProp("checked").removeAttr("checked");$.each(b,function(b,c){c=a[b];var e=d.find("[name="+b+"]");c=null!=c?c+
"":"";e.hasClass("skycheckbox")?-1<c.indexOf(",")?(c=c.split(","),$.each(c,function(a,c){d.find("[name="+b+"][value="+c+"]").prop("checked","checked").trigger("change")})):1==c?d.find("[name="+b+"][value="+c+"]").prop("checked","checked").trigger("change"):e.removeProp("checked").removeAttr("checked").trigger("change"):e.hasClass("skyselect")?-1<c.indexOf(",")?e.val(c.split(",")).trigger("change"):e.val(c).trigger("change"):e.hasClass("skyradio")?""!=c?d.find("[name="+b+"][value="+c+"]").prop("checked",
"checked").trigger("change"):e.removeProp("checked").removeAttr("checked").trigger("change"):e.val(c)})},addDisabled:function(){$(this).find(".skydisabled").prop("disabled","disabled")},removeDisabled:function(){$(this).find(".skydisabled").removeProp("disabled").removeAttr("disabled")},reset:function(){$(this)[0].reset()},clear:function(){var a=$(this);$(".input-group",a).removeClass("has-error");a.setFormData({})},skyDate:function(a){var d=$(this);d.addClass("Wdate");a=$.extend(!0,{format:"yyyy-MM-dd",
maxDateID:null,minDateID:null,maxDate:null,minDate:null},a);var b={};a.format&&(b.dateFmt=a.format);a.maxDateID?b.maxDate="#F{$dp.$D('"+a.maxDateID+"',{d:0});}":a.maxDate&&(b.maxDate=a.maxDate);a.minDateID?b.minDate="#F{$dp.$D('"+a.minDateID+"',{d:0});}":a.minDate&&(b.minDate=a.minDate);d.bind("click.skyDate",function(){WdatePicker(b)})},removeSkyDate:function(){$(this).unbind(".skyDate").removeClass("Wdate");$dp.unbind($(this)[0])}});
jQuery.extend({exportExcel:function(a,d,b,f){var c=layer.load(1,{shade:[.1,"#fff"]});a=$(a).getFormData();var e=[];$.each(b,function(a,b){var c=$(b.grid).data("groupHeaders")||[];a=$(b.grid).getGridParam("colModel");var d=[],f=0;$.each(a,function(a,b){void 0==b.isExcel&&(b.isExcel=!0);a=!1;b.hidden&&b.isHiddenExcel?a=!0:"cb"!=b.name&&"subgrid"!=b.name&&"rn"!=b.name&&"btn"!=b.name&&"id"!=b.name&&!b.hidden&&b.isExcel&&(a=!0);a?(a={},a.label=b.label,a.name=b.name,b.formatter&&("skyDate"==b.formatter?
(a.skyFormatType="date",a.skyFormat=b.formatoptions.format):"skyNumber"==b.formatter&&(a.skyFormatType="number",a.skyFormat=b.formatoptions.format,a.skyFormatUnit=b.formatoptions.unit)),d.push(a),$.each(c,function(a,c){$.each(c.groupHeaderList,function(a,c){if(c.startColumnName==b.name)return c.startColumn=f,!1})}),f++):$.each(c,function(a,c){$.each(c.groupHeaderList,function(a,d){if(d.startColumnName==b.name)return c.groupHeaderList.splice(a,1),!1})})});e.push({fileName:b.fileName,columns:d,groupHeaders:c})});
a.exportParamList=1==b.length?JSON.stringify(e[0]):JSON.stringify(e);$.post(d,a,function(a){window.location.href=encodeURI($.locationpath+"/core/file/download?realName="+a+"&fileName="+f);layer.close(c)},"text")},getLocalCache:function(a,d,b){var f=1,c="",e="";if($.isSupportCache()){if(localStorage.getItem(a)){var h=JSON.parse(localStorage.getItem(a));h.timestamp?c=h.timestamp:(f=2,c="-1");h.usercode?e=h.usercode:(f=2,c="-1")}}else f=3,c="-1";$.ajax({url:d,type:"POST",data:{timestamp:c,usercode:e},
dataType:"json",timeout:1E5,error:function(){return[]},success:function(d){if(3==f)b&&b(d.rows);else{if(1==f&&(c!=d.timestamp||e!=d.usercode)||2==f)localStorage.removeItem(a),localStorage.setItem(a,JSON.stringify(d));b&&b(JSON.parse(localStorage.getItem(a)))}}})},clearAllCache:function(){localStorage.clear()},isSupportCache:function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}},numToRMB:function(a){var d,b,f,c,e,h,l,g,m,k,n;a=a.toString();if(""==a)return alert("Empty input!"),
"";if(null!=a.match(/[^,.\d]/))return alert("Invalid characters in the input string!"),"";if(null==a.match(/^((\d{1,3}(,\d{3})*(.((\d{3},)*\d{1,3}))?)|(\d+(.\d+)?))$/))return alert("Illegal format of digit number!"),"";a=a.replace(/,/g,"");a=a.replace(/^0+/,"");if(9.999999999999E10<Number(a))return alert("Too large a number to convert!"),"";d=a.split(".");1<d.length?(a=d[0],d=d[1],d=d.substr(0,2)):(a=d[0],d="");f="\u96f6\u58f9\u8d30\u53c1\u8086\u4f0d\u9646\u67d2\u634c\u7396".split("");c=["","\u62fe",
"\u4f70","\u4edf"];e=["","\u4e07","\u4ebf"];h=["\u89d2","\u5206"];b="";if(0<Number(a)){for(g=l=0;g<a.length;g++)m=a.length-g-1,k=a.substr(g,1),n=m/4,m%=4,"0"==k?l++:(0<l&&(b+=f[0]),l=0,b+=f[Number(k)]+c[m]),0==m&&4>l&&(b+=e[n]);b+="\u5143"}if(""!=d)for(g=0;g<d.length;g++)k=d.substr(g,1),"0"!=k&&(b+=f[Number(k)]+h[g]);""==b&&(b="\u96f6\u5143");""==d&&(b+="\u6574");return b}});