/**
 *
 * 信息管理部软件开发科Bootstrap插件系列
 * 
 * jquery.sky.jqgrid 基于jqGrid、jquery.sky.form、layer
 *
 * 王歌 2016年11月
 */
(function(a){function g(b,d){if(a(b).data("editable")&&!a(b).data("multiple")){var e=!0,c=a(b).data("lastEdit");c!=d&&(c&&(e=a(b).jqGrid("saveRow",c,!1,"clientArray")),e&&(a(b).jqGrid("editRow",d),a(b).data("lastEdit",d)))}}function f(b){if(!a(b).data("editable"))return!0;var d=!0;if(a(b).data("multiple")){var e=a(b).jqGrid("getDataIDs"),c=[],g=[],f="";a.each(e,function(d,e){a(b).jqGrid("saveRow",e,{url:"clientArray",errorfunc:function(a,b,d){c.push({rowid:a,rowIndex:b,msg:d});""!=f&&(f+="<br>");
f+="\u7b2c"+b+"\u884c\uff1a"+d}})&&g.push(e)});0<c.length&&(d=!1,0<g.length&&a.each(g,function(c,d){a(b).jqGrid("editRow",d)}),layer.alert(f,{shadeClose:!0,title:"\u6821\u9a8c\u4e0d\u901a\u8fc7",icon:2}))}else(e=a(b).data("lastEdit"))&&(d=a(b).jqGrid("saveRow",e,!1,"clientArray")),d&&a(b).removeData("lastEdit");return d}a.fn.skyGrid=function(b,d){if("string"==typeof b)return a.fn.skyGrid.methods[b](this,d);var e=this,c=a.extend(!0,{},a.fn.skyGrid.skyOptions,b.sky);d=a.extend(!0,{},a.fn.skyGrid.defaults,
b);d.sky=null;if(c.editable){c.frozen=!1;d.pager=null;a(e).data("editable",!0);var f=c.edit.multiple;a(e).data("multiple",f);f||(d.ondblClickRow=function(b,c,d,f){g(e,b);var m=a(e).jqGrid("getGridRowById",b);setTimeout(function(){var b=a("td:eq("+d+") :input:visible",m).not(":disabled");0<b.length&&b.focus()},0)})}c.pager?d.pager=c.pager:d.rowNum=0;c.search.form&&(d.serializeGridData=function(b){var d=a(c.search.form).getFormData();a.extend(b,d);return b});a(e).jqGrid(d);if(0<c.groupHeaders.length){var l=
[];a.each(c.groupHeaders,function(b,c){a(e).setGroupHeaders({useColSpanStyle:!0,groupHeaders:c});l.push({index:b,groupHeaderList:c})});a(e).data("groupHeaders",l)}if(c.parent){var h=32,k=0;0<c.groupHeaders.length&&(k=28*c.groupHeaders.length);b.height?a(e).setGridHeight(b.height):(c.pager&&(h=0),a(e).setGridHeight(a(c.parent).height()+h-k));a(e).setGridWidth(a(c.parent).width());a(window).resize(function(){c.frozen&&a(e).jqGrid("destroyFrozenColumns");a(e).setGridWidth(a(c.parent).width());b.height?
a(e).setGridHeight(b.height):(c.pager&&(h=0),a(e).setGridHeight(a(c.parent).height()+h-k));c.frozen&&a(e).jqGrid("setFrozenColumns")})}c.pager&&d.url&&a(e).navGrid(c.pager,{search:!1,add:!1,edit:!1,del:!1,refreshtext:"\u5237\u65b0",refreshicon:"fa fa-refresh text-success"});c.frozen&&a(e).jqGrid("setFrozenColumns");c.search.searchBtn&&a(c.search.searchBtn).click(function(){var b=!0;c.search.beforeSearch&&(b=c.search.beforeSearch());!b||c.search.validate&&!a(c.search.form).valid()||(c.search.searchFunction?
c.search.searchFunction():a(e).setGridParam({datatype:"json"}).trigger("reloadGrid",[{page:1}]))});c.search.exportBtn&&c.search.exportUrl&&c.search.form&&c.search.exportName&&a(c.search.exportBtn).click(function(){var b=!0;c.search.beforeExport&&(b=c.search.beforeExport());!b||c.search.validate&&!a(c.search.form).valid()||(c.search.exportFunction?c.search.exportFunction():(b=[],b.push({fileName:c.search.exportName,grid:e}),a.exportExcel(c.search.form,c.search.exportUrl,b,c.search.exportName)))})};
a.fn.skyGrid.methods={addInlineRow:function(b){b=b[0];if(a(b).data("editable")){var d=!0,e=a(b).data("multiple");if(!e){var c=a(b).data("lastEdit");c&&(d=a(b).jqGrid("saveRow",c,!1,"clientArray"))}d&&(d=(new Date).getTime(),a(b).jqGrid("addRow",{rowID:d,initdata:{id:d},position:"last",useDefValues:!0,useFormatter:!1,addRowParams:{extraparam:{}}}),e||a(b).data("lastEdit",d))}},editInlineRow:function(a,d){return g(a[0],d)},deleteInlineRow:function(b,d){b=b[0];if(a(b).data("editable")){var e=a(b).data("lastEdit");
a(b).jqGrid("delRowData",d);e==d&&a(b).removeData("lastEdit")}},endEdit:function(a){return f(a[0])}};a.fn.skyGrid.skyOptions={parent:null,pager:null,frozen:!1,search:{form:null,validate:!1,searchBtn:null,searchFunction:null,beforeSearch:null,exportBtn:null,exportUrl:null,exportName:null,exportFunction:null,beforeExport:null},groupHeaders:[],editable:!1,edit:{multiple:!1,addBtn:null,completeBtn:null}};a.fn.skyGrid.defaults={styleUI:"Bootstrap",loadtext:"\u6b63\u5728\u52a0\u8f7d\u6570\u636e\uff0c\u8bf7\u7a0d\u5019\u2026\u2026",
rownumbers:!0,jsonReader:{root:"rows",total:"totalPage",records:"total",repeatitems:!0},viewrecords:!0,url:null,mtype:"POST",datatype:"json",height:"auto",autowidth:!0,shrinkToFit:!1,autoScroll:!1,altRows:!0,cmTemplate:{sortable:!1},rowNum:20,rowList:[10,20,30,50],loadError:function(a,d,e){-1!=a.responseText.substring(0,14).indexOf("success:false")&&(a=a.responseText.substring(24,a.responseText.length-2),layer.alert("\u6570\u636e\u52a0\u8f7d\u5931\u8d25\uff01"+a,{shadeClose:!0,title:"\u63d0\u793a",
icon:2}))}}})(jQuery);
jQuery.extend($.fn.fmatter,{btn:function(a,g,f){var b={title:"",btnClass:"",func:"",args:[],text:"",icon:"",enable:{name:"",value:[]}};a='<div style="margin:-2px">';if(void 0!==g.colModel.formatoptions){b=$.extend(b,g.colModel.formatoptions);var d='disabled="disabled"';b.enable.name?($.each(b.enable.value,function(a,c){if(f[b.enable.name]==c)return d="",!1}),""!=d&&(b.btnClass="btn-default")):d="";a+="<button "+d+' title="'+b.title+'" class="btn btn-outline btn-xs '+b.btnClass+'" type="button" onclick="javascript:'+
b.func+"(";for(g=0;g<b.args.length;g++)a+="'"+f[b.args[g]]+"'",g<b.args.length-1&&(a+=",");a=a+');">'+('<i class="fa '+b.icon+'"></i>'+b.text+"</button>")}else a+='<button title="" class="btn btn-outline btn-primary" type="button" onclick="javascript:;"><i class="fa fa-pencil-square-o"></i></button>';return a+"</div>"},skyDate:function(a,g,f){f={format:"yyyy-MM-dd HH:mm:ss"};return void 0!==g.colModel.formatoptions?(f=$.extend(f,g.colModel.formatoptions),null!=a?(new Date(Date.parse(a.replace(/-/g,
"/")))).format(f.format):""):a},skyNumber:function(a,g,f){f={format:"0",unit:1};if(void 0!==g.colModel.formatoptions){f=$.extend(f,g.colModel.formatoptions);if(null==a||isNaN(a))return"";a=Number(a);f.unit&&(a/=f.unit);return numeral(a).format(f.format)}return a}});