/**
 *
 * 信息管理部软件开发科Bootstrap插件系列
 * 
 * jquery.sky.skyRemoteSelect 远程数据选择框-基于layer
 *
 * 王歌 2016年11月
 */
(function(c){function v(a,b){var d=b.multiple?"fa-search-plus":"fa-search";b.gridMode?(c(a).wrap('<span style="cursor:pointer;" class="input-icon input-icon-right"></span>'),c(a).parent("span").append('<i class="fa '+d+' openBtn primary"></i>')):c('<span class="input-group-addon openBtn primary"><i class="fa '+d+'"></i></span>').insertAfter(a).css({cursor:"pointer"});a=(new Date).getTime();a=c('<div id="'+a+'" class="wrapper wrapper-content animated fadeInRight" style="display:none;"></div>').appendTo("body");
var f='<div class="row">',g=!1;c.each(b.columns,function(a,c){c.search&&(g=!0,f+='<div class="col-md-5 col-sm-5"><div class="input-group input-group-sm m-b-sm"><span class="input-group-addon" style="height:26px;padding:3px 5px">'+c.title+'</span><input type="text" name="'+c.field+'" class="form-control selectboxinput" style="height:26px;padding:3px 5px"></div></div>')});g&&(f+='<div class="col-md-2 col-sm-2"><button class="btn btn-primary btn-xs selectboxbtn"><i class="fa fa-search"></i>&nbsp;\u67e5\u8be2</button></div>');
f+='<div class="col-md-12 col-sm-12"><table class="selectboxmain table table-hover table-bordered m-b-none"></table>';b.multiple&&(f+='<div class="m-t-xs" style="height:150px;overflow-y:scroll;"><table class="selectboxresult table table-hover table-bordered m-b-none"></table></div>');f+="</div></div></div>";a.append(f);var d=c("<thead></thead>"),e=c("<tr></tr>"),k=c('<th style="width:10px;"></th>'),h=c("<tfoot></tfoot>");b.multiple&&c('<input type="checkbox" class="selectboxcheckall" />').appendTo(k);
k.appendTo(e);c.each(b.columns,function(a,b){a=c("<th></th>").css({"white-space":"nowrap"});b.title&&a.html(b.title);b.field&&a.prop("field",b.field);a.appendTo(e)});e.appendTo(d);d.children("tr").addClass("active");a.find(".selectboxmain").append(d);k=c("<tbody></tbody>");a.find(".selectboxmain").append(k);h.append('<tr><td colspan="'+e.children().length+'"><table class="page-div" style="width:100%;"><tr><td style="width:300px;"><div>\u7b2c<label class="page-num-start">0</label>-<label class="page-num-stop">0</label>\u6761 ,\u5171<label class="page-num-total">0</label>\u6761</div></td><td><div style="width:100%;text-align:right;"><button class="btn btn-xs btn-white btn-bitbucket disabled page-first" type="button"><i class="fa fa-step-backward"></i></button>&emsp;<button class="btn btn-xs btn-white btn-bitbucket disabled page-previous" type="button"><i class="fa fa-backward"></i></button>&emsp;\u7b2c<label class="page-num">1</label>\u9875&emsp;<button class="btn btn-xs btn-white btn-bitbucket disabled page-next" type="button"><i class="fa fa-forward"></i></button>&emsp;<button class="btn btn-xs btn-white btn-bitbucket disabled page-last" type="button"><i class="fa fa-step-forward"></i></button><div></td></tr></table></td></tr>');
a.find(".selectboxmain").append(h);b.multiple&&(d=d.clone(),d.find(".selectboxcheckall").remove(),a.find(".selectboxresult").append(d),a.find(".selectboxresult").append(k.clone()));a.find(".table>thead th").css({padding:"3px 5px"});a.find(".table>tbody>tr>td").css({padding:"2px 5px"});a.data("options",b);return a}function w(a){var b=c(a).data("skyRemoteSelect");b.data("options");b.find("*").unbind(".skyRemoteSelect");b.find(".page-first").bind("click.skyRemoteSelect",function(){l(a,1)});b.find(".page-previous").bind("click.skyRemoteSelect",
function(){var b=c(a).data("currentPage");l(a,1<b?b-1:1)});b.find(".page-next").bind("click.skyRemoteSelect",function(){var b=c(a).data("currentPage"),f=c(a).data("totalPage");l(a,b<f?b+1:f)});b.find(".page-last").bind("click.skyRemoteSelect",function(){var b=c(a).data("totalPage");l(a,b)});b.find(".selectboxbtn").bind("click.skyRemoteSelect",function(){l(a,1)});c(a).parent().find(".openBtn").bind("click.skyRemoteSelect",function(){q(a)});b.find(".selectboxcheckall").bind("click.skyRemoteSelect",
function(){if(c(this).prop("checked")){var d=b.find(".selectboxmain>tbody>tr").not(".nodata").not(".active");c.each(d,function(b,d){b=c(this).find("input:checkbox");b.prop("checked")?b.removeProp("checked").removeAttr("checked"):b.prop("checked","checked");m(a,b)})}else d=b.find(".selectboxmain>tbody>tr.active"),c.each(d,function(b,d){b=c(this).find("input:checkbox");b.prop("checked")?b.removeProp("checked").removeAttr("checked"):b.prop("checked","checked");m(a,b)})})}function q(a){l(a,0);var b=c(a).data("skyRemoteSelect"),
d=b.data("options"),b={id:"layer_"+b.attr("id"),type:1,title:d.title,area:["600px"],content:b,success:function(b,d){c(a).data("index",d)},end:function(){c(a).removeData("index")},btn:["\u786e\u5b9a","\u53d6\u6d88"],yes:function(c,b){layer.close(c);n(a)},btn2:function(a,c){d.cancel&&d.cancel()},cancel:function(){}};d.multiple&&c.extend(b,{btn:["\u786e\u5b9a","\u91cd\u65b0\u9009\u62e9","\u53d6\u6d88"],yes:function(c,b){layer.close(c);n(a)},btn2:function(b,d){b=c(a).data("skyRemoteSelect");c(a).removeData("selectedData");
b.find(".selectboxinput").val("");l(a,1)},btn3:function(a,c){d.cancel&&d.cancel()}});layer.open(b)}function n(a){var b=c(a).data("skyRemoteSelect").data("options");a=c(a).data("selectedData")||[];b.confirm&&(b.multiple||(a=a[0]),b.confirm(a))}function l(a,b){var d=layer.load(1,{shade:[.1,"#fff"]}),f=c(a).data("skyRemoteSelect"),g=f.data("options");c(a).data("selectedData");0==b&&(b=1,f.find(".selectboxinput").val(""));f.find(".selectboxmain>tbody").empty();var e=c.extend({},g.param,{page:b,rows:g.pageSize});
c.each(g.columns,function(a,c){c.search&&(e[c.field]=f.find(".selectboxinput[name='"+c.field+"']").val())});c.ajax({url:g.url,data:e,async:!1,type:"POST",dataType:"json",success:function(d){for(var h=d.rows,e=0;e<g.pageSize;e++)e<h.length?r(a,h[e]):r(a,null);h=f.find(".page-div");e=Math.ceil(d.total/g.pageSize);c(a).data("totalPage",e);var e=(b-1)*g.pageSize+1,k=e+g.pageSize-1,k=k<d.total?k:d.total;h.find(".page-num-start").html(e);h.find(".page-num-stop").html(k);h.find(".page-num-total").html(d.total);
h.find(".page-num").html(b);d=b;h=c(a).data("skyRemoteSelect");e=c(a).data("totalPage");1==d?(h.find(".page-first").addClass("disabled"),h.find(".page-previous").addClass("disabled"),h.find(".page-next").removeClass("disabled"),h.find(".page-last").removeClass("disabled")):d==e?(h.find(".page-first").removeClass("disabled"),h.find(".page-previous").removeClass("disabled"),h.find(".page-next").addClass("disabled"),h.find(".page-last").addClass("disabled")):1<d&&d<e&&(h.find(".page-first").removeClass("disabled"),
h.find(".page-previous").removeClass("disabled"),h.find(".page-next").removeClass("disabled"),h.find(".page-last").removeClass("disabled"));1==e&&(h.find(".page-first").addClass("disabled"),h.find(".page-previous").addClass("disabled"),h.find(".page-next").addClass("disabled"),h.find(".page-last").addClass("disabled"));c(a).data("currentPage",b)}});layer.close(d)}function r(a,b){var d=c(a).data("skyRemoteSelect"),f=d.data("options"),g=c(a).data("selectedData")||[],d=d.find(".selectboxmain>tbody"),
e=c("<tr></tr>");b?(e.append('<td><input type="checkbox"/></td>'),c.each(f.columns,function(a,d){a=c("<td></td>");a.html(b[d.field]);a.appendTo(e)}),e.data("data",b),c.each(g,function(a,c){if(c[f.valueColumn]==b[f.valueColumn])return e.find("input:checkbox").prop("checked","checked"),e.addClass("active"),!1})):(e.addClass("nodata"),e.append("<td>&nbsp;</td>"),c.each(f.columns,function(a,b){c("<td></td>").appendTo(e)}));e.children("td").css({padding:"2px 5px",cursor:"pointer"});e.appendTo(d);t(a);
e.not(".nodata").bind("dblclick.skyRemoteSelect",function(){var b=c(this).find("input:checkbox");b.prop("checked")?b.removeProp("checked").removeAttr("checked"):b.prop("checked","checked");m(a,b);!f.multiple&&c(this).find("input:checkbox").prop("checked")&&(b=c(a).data("index"),layer.close(b),n(a))});e.find("input:checkbox").bind("click.skyRemoteSelect",function(){m(a,c(this))})}function t(a){a=c(a).data("skyRemoteSelect");var b=a.data("options");a.find(".selectboxmain>tbody").find("tr.active").length==
b.pageSize?a.find(".selectboxcheckall").prop("checked","checked"):a.find(".selectboxcheckall").removeProp("checked").removeAttr("checked")}function x(a,b){var d=c(a).data("skyRemoteSelect"),f=d.data("options"),d=d.find(".selectboxresult>tbody"),g=c("<tr></tr>");c('<td><input type="checkbox" checked="checked" /></td>').appendTo(g);c.each(f.columns,function(a,d){a=c("<td></td>");a.html(b[d.field]);a.appendTo(g)});g.data("data",b);g.addClass("active").bind("dblclick.skyRemoteSelect",function(){u(a,c(this))});
g.find("input:checkbox").bind("click.skyRemoteSelect",function(){u(a,c(this).parents("tr"))});g.children("td").css({padding:"2px",cursor:"pointer"});g.appendTo(d)}function m(a,b){var d=c(a).data("skyRemoteSelect"),f=d.data("options"),g=b.closest("tr");b=b.prop("checked");var e=c(a).data("selectedData")||[],k=g.data("data");if(f.multiple)if(b){var h=!1;c.each(e,function(a,c){if(c[f.valueColumn]==k[[f.valueColumn]])return h=!0,!1});h||(e.push(k),x(a,k),g.addClass("active"),t(a))}else g.removeClass("active"),
c.each(e,function(a,c){if(c[f.valueColumn]==k[f.valueColumn])return e.splice(a,1),!1}),d=d.find(".selectboxresult>tbody"),c.each(d.children("tr"),function(a,b){if(c(b).data("data")[f.valueColumn]==k[f.valueColumn])return c(b).remove(),!1});else g.removeClass("active").siblings().removeClass("active").find("input:checkbox").removeProp("checked").removeAttr("checked"),e=[],b&&(g.addClass("active"),e.push(k));c(a).data("selectedData",e)}function u(a,b){var d=c(a).data("skyRemoteSelect"),f=d.data("options"),
g=c(a).data("selectedData"),e=d.find(".selectboxmain>tbody"),g=g||[],k=b.data("data");b.remove();c.each(g,function(a,c){if(c[f.valueColumn]==k[f.valueColumn])return g.splice(a,1),!1});c.each(e.children("tr").not(".nodata"),function(a,b){if(c(b).data("data")[f.valueColumn]==k[f.valueColumn])return c(b).find("input:checkbox").removeProp("checked").removeAttr("checked"),c(b).removeClass("active"),!1});d.find(".selectboxcheckall").removeProp("checked").removeAttr("checked");c(a).data("selectedData",g)}
function p(a,b){var d=c(a).data("skyRemoteSelect").data("options"),f=c(a).parent();d.disabled=b;c(a).addClass("skydisabled").prop("disabled","disabled");f.find(".openBtn").removeClass("primary").unbind("click.skyRemoteSelect");b||(c(a).removeClass("skydisabled").removeProp("disabled").removeAttr("disabled"),f.find(".openBtn").addClass("primary").bind("click.skyRemoteSelect",function(){q(a)}))}c.fn.skyRemoteSelect=function(a,b){return"string"==typeof a?c.fn.skyRemoteSelect.methods[a](this,b):this.each(function(){var b=
c(this).data("skyRemoteSelect");b?(b=b.data("options"),c.extend(b,a)):(a.pageSize=a.multiple?a.pageSize?a.pageSize:5:a.pageSize?a.pageSize:10,a=c.extend({},c.fn.skyRemoteSelect.defaults,a),b=v(this,a),c(this).data("skyRemoteSelect",b),w(this));p(this,a.disabled)})};c.fn.skyRemoteSelect.methods={disable:function(a){return a.each(function(){p(this,!0)})},enable:function(a){return a.each(function(){p(this,!1)})}};c.fn.skyRemoteSelect.defaults={title:"\u9009\u62e9\u6846",url:"",param:{},gridMode:!1,valueColumn:"",
columns:[],separator:",",disabled:!1,multiple:!1,pageSize:0,confirm:function(a){},cancel:function(){}}})(jQuery);