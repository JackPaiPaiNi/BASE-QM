/**
 *
 * 信息管理部软件开发科Bootstrap插件系列
 * 
 * jquery.sky.skySelect 本地数据选择框-基于layer skyAutoComplete
 *
 * 王歌 2016年11月
 */
(function(c){function B(a,b){a=(new Date).getTime();a=c('<div id="'+a+'" class="wrapper wrapper-content animated fadeInRight" style="display:none;"></div>').appendTo("body");var d='<div class="row">';c.each(b.columns,function(a,c){c.search&&(d+='<div class="col-md-6 col-sm-6"><div class="input-group input-group-sm m-b-sm"><span class="input-group-addon" style="height:26px;padding:3px 5px">'+c.title+'</span><input type="text" name="'+c.field+'" class="form-control selectboxinput" style="height:26px;padding:3px 5px"></div></div>')});
d+='<div class="col-md-12 col-sm-12"><table class="selectboxmain table table-hover table-bordered m-b-none"></table>';b.multiple&&(d+='<div class="m-t-xs" style="height:150px;overflow-y:scroll;"><table class="selectboxresult table table-hover table-bordered m-b-none"></table></div>');d+="</div></div></div>";a.append(d);var e=c("<thead></thead>"),f=c("<tr></tr>"),g=c('<th style="width:10px;"></th>'),h=c("<tfoot></tfoot>");b.multiple&&c('<input type="checkbox" class="selectboxcheckall" />').appendTo(g);
g.appendTo(f);c.each(b.columns,function(a,b){a=c("<th></th>").css({"white-space":"nowrap"});b.title&&a.html(b.title);b.field&&a.prop("field",b.field);a.appendTo(f)});f.appendTo(e);e.children("tr").addClass("active");a.find(".selectboxmain").append(e);g=c("<tbody></tbody>");a.find(".selectboxmain").append(g);h.append('<tr><td colspan="'+f.children().length+'"><table class="page-div" style="width:100%;"><tr><td style="width:300px;"><div>\u7b2c<label class="page-num-start">0</label>-<label class="page-num-stop">0</label>\u6761 ,\u5171<label class="page-num-total">0</label>\u6761</div></td><td><div style="width:100%;text-align:right;"><button class="btn btn-xs btn-white btn-bitbucket disabled page-first" type="button"><i class="fa fa-step-backward"></i></button>&emsp;<button class="btn btn-xs btn-white btn-bitbucket disabled page-previous" type="button"><i class="fa fa-backward"></i></button>&emsp;\u7b2c<label class="page-num">1</label>\u9875&emsp;<button class="btn btn-xs btn-white btn-bitbucket disabled page-next" type="button"><i class="fa fa-forward"></i></button>&emsp;<button class="btn btn-xs btn-white btn-bitbucket disabled page-last" type="button"><i class="fa fa-step-forward"></i></button><div></td></tr></table></td></tr>');
a.find(".selectboxmain").append(h);b.multiple&&(e=e.clone(),e.find(".selectboxcheckall").remove(),a.find(".selectboxresult").append(e),a.find(".selectboxresult").append(g.clone()));a.find(".table>thead th").css({padding:"3px 5px"});a.find(".table>tbody>tr>td").css({padding:"2px 5px"});a.data("options",b);return a}function C(a){var b=c(a).data("skySelect").data("options");c('<span class="input-group-addon openBtn primary"><i class="fa '+(b.multiple?"fa-search-plus":"fa-search")+'"></i></span>').insertAfter(a).css({cursor:"pointer"});
var d=c(a).parent();d.find(".openBtn").bind("click.skySelect",function(){p(a)});b.autoComplete&&!b.multiple&&c(a).skyAutoComplete({displayText:b.displayText,text:b.textColumn,appendTo:d,afterSelect:function(b){var c=[];c.push(b);q(a,c);m(a)}})}function D(a){var b=c(a).data("skySelect"),d=b.data("options");b.find("*").unbind(".skySelect");c.each(d.columns,function(c,d){d.search&&b.find("input[name="+d.field+"]").bind("keyup.skySelect",function(){E(a)})});b.find(".page-first").bind("click.skySelect",
function(){l(a,1)});b.find(".page-previous").bind("click.skySelect",function(){var c=b.data("currentPage");l(a,1<c?c-1:1)});b.find(".page-next").bind("click.skySelect",function(){var c=b.data("currentPage"),d=b.data("totalPage");l(a,c<d?c+1:d)});b.find(".page-last").bind("click.skySelect",function(){var c=b.data("totalPage");l(a,c)});b.find(".selectboxcheckall").bind("click.skySelect",function(){if(c(this).prop("checked")){var d=b.find(".selectboxmain>tbody>tr").not(".nodata").not(".active");c.each(d,
function(b,d){b=c(this).find("input:checkbox");b.prop("checked")?b.removeProp("checked").removeAttr("checked"):b.prop("checked","checked");n(a,b)})}else d=b.find(".selectboxmain>tbody>tr.active"),c.each(d,function(b,d){b=c(this).find("input:checkbox");b.prop("checked")?b.removeProp("checked").removeAttr("checked"):b.prop("checked","checked");n(a,b)})})}function p(a){var b=c(a).data("skySelect"),d=b.data("options"),b={id:"layer_"+b.attr("id"),type:1,title:d.title,area:[d.width],content:b,success:function(b,
d){c(a).data("index",d)},end:function(){c(a).removeData("index")},btn:["\u786e\u5b9a","\u53d6\u6d88"],yes:function(b,c){layer.close(b);m(a)},btn2:function(a,b){d.cancel&&d.cancel()},cancel:function(){}};d.multiple&&c.extend(b,{btn:["\u786e\u5b9a","\u91cd\u65b0\u9009\u62e9","\u53d6\u6d88"],yes:function(b,c){layer.close(b);m(a)},btn2:function(b,c){q(a,[])},btn3:function(a,b){d.cancel&&d.cancel()}});if(d.valueElem){var e=c(d.valueElem).val()||"",f=c(a).data("value")||"";e!=f&&u(a,e)}layer.open(b)}function m(a){for(var b=
c(a).data("skySelect").data("options"),d=c(a).data("selectedData")||[],e="",f="",g=0;g<d.length;g++)e+=d[g][b.valueColumn]+b.separator,f+=d[g][b.textColumn]+b.separator;""!=e&&(e=e.substring(0,e.lastIndexOf(b.separator)),f=f.substring(0,f.lastIndexOf(b.separator)));b.valueElem&&c(b.valueElem).val(e);b.textElem?c(b.textElem).val(f):c(a).val(f);c(a).data("value",e);c(a).data("text",f);b.gridMode?(a=c(a).data("gridSelect"),g=c(a).data("gridSelect").data("options"),c(a).data("selectedData",d),c(a).data("value",
e),c(a).data("text",f),g.confirm&&(b.multiple?g.confirm(d,e,f):g.confirm(d[0],e,f))):b.confirm&&(b.multiple?b.confirm(d,e,f):b.confirm(d[0],e,f))}function q(a,b){var d=c(a).data("skySelect"),e=d.data("options");c(a).data("selectedData",b);d.find(".selectboxinput").val("");d.data("filterData",e.data);l(a,1);var f=d.find(".selectboxmain>tbody>tr").not(".nodata");f.removeClass("active").find("input:checkbox").removeProp("checked").removeAttr("checked");d=d.find(".selectboxresult>tbody");e.multiple&&
d.empty();c.each(b,function(b,d){c.each(f,function(a,b){a=c(b).data("data");d[e.valueColumn]==a[e.valueColumn]&&c(b).addClass("active").find("input:checkbox").prop("checked","checked")});e.multiple&&v(a,d)})}function w(a,b){var d=c(a).data("skySelect"),e=d.data("options"),f=c(a).data("selectedData")||[],d=d.find(".selectboxmain>tbody"),g=c("<tr></tr>");b?(g.append('<td><input type="checkbox"/></td>'),c.each(e.columns,function(a,d){a=c("<td></td>");a.html(b[d.field]);a.appendTo(g)}),g.data("data",
b),c.each(f,function(a,c){if(c[e.valueColumn]==b[e.valueColumn])return g.find("input:checkbox").prop("checked","checked"),g.addClass("active"),!1})):(g.addClass("nodata"),g.append("<td>&nbsp;</td>"),c.each(e.columns,function(a,b){c("<td></td>").appendTo(g)}));g.children("td").css({padding:"2px 5px",cursor:"pointer"});g.appendTo(d);r(a);g.not(".nodata").bind("dblclick.skySelect",function(){var b=c(this).find("input:checkbox");b.prop("checked")?b.removeProp("checked").removeAttr("checked"):b.prop("checked",
"checked");n(a,b);!e.multiple&&c(this).find("input:checkbox").prop("checked")&&(b=c(a).data("index"),layer.close(b),m(a))});g.find("input:checkbox").bind("click.skySelect",function(){n(a,c(this))})}function r(a){a=c(a).data("skySelect");var b=a.data("options");a.find(".selectboxmain>tbody").find("tr.active").length==b.pageSize?a.find(".selectboxcheckall").prop("checked","checked"):a.find(".selectboxcheckall").removeProp("checked").removeAttr("checked")}function v(a,b){var d=c(a).data("skySelect"),
e=d.data("options"),d=d.find(".selectboxresult>tbody"),f=c("<tr></tr>");c('<td><input type="checkbox" checked="checked" /></td>').appendTo(f);c.each(e.columns,function(a,d){a=c("<td></td>");a.html(b[d.field]);a.appendTo(f)});f.data("data",b);f.addClass("active").bind("dblclick.skySelect",function(){x(a,c(this))});f.find("input:checkbox").bind("click.skySelect",function(){x(a,c(this).parents("tr"))});f.children("td").css({padding:"2px",cursor:"pointer"});f.appendTo(d)}function E(a){var b=c(a).data("skySelect"),
d=b.data("options"),e=d.data,f=[],g="";c.each(d.columns,function(a,c){c.search&&(a=b.find("input[name="+c.field+"]").val()+"",g+=a,f.push({field:c.field,value:a}))});var h=[];0<g.length?c.each(e,function(a,b){var d=!0;c.each(f,function(a,c){0<c.value.length&&(d=-1<b[c.field].toUpperCase().indexOf(c.value.toUpperCase())?d&&!0:d&&!1)});d&&h.push(b)}):h=e;b.data("filterData",h);b.data("totalPage",Math.ceil(h.length/d.pageSize));l(a,1)}function n(a,b){var d=c(a).data("skySelect"),e=d.data("options"),
f=b.closest("tr");b=b.prop("checked");var g=c(a).data("selectedData")||[],h=f.data("data");if(e.multiple)if(b){var k=!1;c.each(g,function(a,b){if(b[e.valueColumn]==h[[e.valueColumn]])return k=!0,!1});k||(g.push(h),v(a,h),f.addClass("active"),r(a))}else f.removeClass("active"),c.each(g,function(a,b){if(b[e.valueColumn]==h[e.valueColumn])return g.splice(a,1),!1}),d=d.find(".selectboxresult>tbody"),c.each(d.children("tr"),function(a,b){if(c(b).data("data")[e.valueColumn]==h[e.valueColumn])return c(b).remove(),
!1});else f.removeClass("active").siblings().removeClass("active").find("input:checkbox").removeProp("checked").removeAttr("checked"),g=[],b&&(f.addClass("active"),g.push(h));c(a).data("selectedData",g)}function x(a,b){var d=c(a).data("skySelect"),e=d.data("options"),f=c(a).data("selectedData")||[],d=d.find(".selectboxmain>tbody"),g=b.data("data");b.remove();c.each(f,function(a,b){if(b[e.valueColumn]==g[e.valueColumn])return f.splice(a,1),!1});c.each(d.children("tr").not(".nodata"),function(b,d){if(c(d).data("data")[e.valueColumn]==
g[e.valueColumn])return c(d).find("input:checkbox").removeProp("checked").removeAttr("checked"),c(d).removeClass("active"),r(a),!1});c(a).data("selectedData",f)}function y(a){var b=c(a).data("skySelect").data("options");a=c(a).data("selectedData")||[];b.multiple||(a=a[0]||{});return a}function u(a,b){var d=c(a).data("skySelect").data("options"),e=d.data,f=(null==b?"":b+"").split(d.separator),g=[],h=0;c.each(f,function(a,b){c.each(e,function(a,c){if(c[d.valueColumn]==b&&(g.push(c),h++,f.length==h))return!1})});
q(a,g)}function F(a,b){var d=c(a).data("skySelect").data("options");if(b){if(b==d.textColumn)return c(a).data("text")||"";a=y(a);if(d.multiple){for(var e="",f=0;f<a.length;f++)e+=a[f][b]||"",e+=d.separator;""!=e&&(e=e.substring(0,e.lastIndexOf(d.separator)));return e}return a[b]||""}return c(a).data("value")||""}function t(a,b){var d=c(a).data("skySelect").data("options"),e=c(a).parent();d.disabled=b;c(a).addClass("skydisabled").prop("disabled","disabled");e.find(".openBtn").removeClass("primary").unbind("click.skySelect");
b||(c(a).removeClass("skydisabled").removeProp("disabled").removeAttr("disabled"),e.find(".openBtn").addClass("primary").bind("click.skySelect",function(){p(a)}))}function z(a,b){var d=layer.load(1,{shade:[.1,"#fff"]}),e=c(a).data("skySelect"),f=e.data("options");e.data("filterData",b);f.data=b;!f.autoComplete||f.multiple||f.gridMode||c(a).skyAutoComplete("setSource",b);f.gridMode&&c.each(c("[gridTargetID="+f.gridTargetID.replace("#","")+"]"),function(){var a=c(this).data("gridSelect"),a=c(a).data("options");
!f.multiple&&a.autoComplete&&c(this).skyAutoComplete("setSource",b)});e.data("totalPage",Math.ceil(b.length/f.pageSize));l(a,1);if(f.onComplete)f.onComplete();layer.close(d)}function l(a,b){var d=c(a).data("skySelect"),e=d.data("options"),f=d.data("filterData");d.find(".selectboxmain>tbody").empty();for(var g=e.pageSize*(b-1)+1,h=0;h<e.pageSize;h++){var k=g+h;k<f.length+1?w(a,f[k-1]):w(a,null)}a=d.find(".page-div");h=Math.ceil(f.length/e.pageSize);d.data("totalPage",h);g=(b-1)*e.pageSize+1;e=g+e.pageSize-
1;e=e<f.length?e:f.length;a.find(".page-num-start").html(g);a.find(".page-num-stop").html(e);a.find(".page-num-total").html(f.length);a.find(".page-num").html(b);d.data("currentPage",b);1==b?(d.find(".page-first").addClass("disabled"),d.find(".page-previous").addClass("disabled"),d.find(".page-next").removeClass("disabled"),d.find(".page-last").removeClass("disabled")):b==h?(d.find(".page-first").removeClass("disabled"),d.find(".page-previous").removeClass("disabled"),d.find(".page-next").addClass("disabled"),
d.find(".page-last").addClass("disabled")):1<b&&b<h&&(d.find(".page-first").removeClass("disabled"),d.find(".page-previous").removeClass("disabled"),d.find(".page-next").removeClass("disabled"),d.find(".page-last").removeClass("disabled"));1==h&&(d.find(".page-first").addClass("disabled"),d.find(".page-previous").addClass("disabled"),d.find(".page-next").addClass("disabled"),d.find(".page-last").addClass("disabled"))}function A(a,b){var d=layer.load(1,{shade:[.1,"#fff"]}),e=[];c.ajax({url:a,data:b,
async:!1,type:"POST",dataType:"json",success:function(a){e=a}});layer.close(d);return e}c.fn.skySelect=function(a,b){return"string"==typeof a?c.fn.skySelect.methods[a](this,b):this.each(function(){var b=c(this).data("skySelect");if(b){b=b.data("options");if(a.url||!c.isEmptyObject(b.param)){var e;if(!(e=a.url!=b.url)){a:{e=a.param;var f=b.param,g=Object.getOwnPropertyNames(e),h=Object.getOwnPropertyNames(f);if(g.length!=h.length)e=!1;else{for(h=0;h<g.length;h++){var k=g[h];if(e[k]!==f[k]){e=!1;break a}}e=
!0}}e=!e}e&&(a.data=A(a.url,a.param))}c.extend(b,a);a.gridMode=b.gridMode}else a=c.extend({},c.fn.skySelect.defaults,a),a.pageSize=a.multiple?a.pageSize?a.pageSize:5:a.pageSize?a.pageSize:10,a.url&&(a.data=A(a.url,a.param)),b=B(this,a),c(this).data("skySelect",b),D(this),a.gridMode||C(this);a.data&&z(this,a.data);a.gridMode||t(this,a.disabled)})};c.fn.skySelect.methods={loadData:function(a,b){return a.each(function(){z(this,b)})},disable:function(a){return a.each(function(){t(this,!0)})},enable:function(a){return a.each(function(){t(this,
!1)})},open:function(a){return a.each(function(){p(this)})},getValueData:function(a){return y(a[0])},getValue:function(a,b){return F(a[0],b)},getText:function(a){return c(a[0]).data("text")||""},setValue:function(a,b){return a.each(function(){u(this,b)})}};c.fn.skySelect.defaults={title:"\u9009\u62e9\u6846",width:"600px",url:"",param:{},valueColumn:"",textColumn:"",valueElem:"",textElem:"",autoComplete:!1,displayText:[],columns:[],separator:",",disabled:!1,multiple:!1,gridMode:!1,gridTargetID:null,
pageSize:0,data:[],confirm:function(a,b,c){},cancel:function(){},onComplete:function(){}}})(jQuery);