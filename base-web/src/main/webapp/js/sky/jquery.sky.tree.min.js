/**
 *
 * 信息管理部软件开发科Bootstrap插件系列
 * 
 * jquery.sky.tree 树选择框-基于zTree、layer、skyAutoComplete
 *
 * 王歌 2016年11月
 */
(function(d){function t(a,b){var c=b.multiple?"fa-list":"fa-indent";b.gridMode?(d(a).wrap('<span style="cursor:pointer;" class="input-icon input-icon-right"></span>'),d(a).parent("span").append('<i class="fa '+c+' openBtn primary"></i>')):d('<span class="input-group-addon openBtn primary"><i class="fa '+c+'"></i></span>').insertAfter(a).css({cursor:"pointer"});c=(new Date).getTime();c=d('<div id="'+c+'" class="wrapper wrapper-content animated fadeInRight" style="display:none;"><div id="tree_'+c+'" class="ztree"></div></div>').appendTo("body");
c.data("options",b);var e=d(a).parent();e.find(".openBtn").bind("click.skyTree",function(){n(a)});b.gridMode&&(e=d(a).closest("td"));b.autoComplete&&!b.multiple&&d(a).skyAutoComplete({displayText:b.displayText,text:b.tree.name,appendTo:e,afterSelect:function(c){b.confirm&&(h(a,c[b.tree.idKey]),l(a))}});return c}function n(a){var b=d(a).data("skyTree"),c=b.data("options"),b={id:"layer_"+b.attr("id"),type:1,title:c.title,area:[c.width,c.height],content:b,success:function(c,b){d(a).data("index",b)},
end:function(){d(a).removeData("index")},btn:["\u786e\u5b9a","\u53d6\u6d88"],yes:function(c,b){layer.close(c);l(a)},btn2:function(a,b){c.cancel&&c.cancel()},cancel:function(){}};if(c.valueElem){var e=d(c.valueElem).val()||"",f=d(a).data("value")||"";e!=f&&h(a,e)}layer.open(b)}function l(a){var b=d(a).data("skyTree"),c=b.data("options"),b="tree_"+b.attr("id"),e="",f="",b=d.fn.zTree.getZTreeObj(b),g;c.multiple?(checkedNodeTemp=b.getCheckedNodes()||[],g=[],d.each(checkedNodeTemp,function(a,b){b.isParent&&
c.returnLeaf||(""!=e&&(e+=c.separator,f+=c.separator),e+=b[c.tree.idKey],f+=b[c.tree.name],g.push(b))})):(g=b.getSelectedNodes()||[],e=g[0][c.tree.idKey],f=g[0][c.tree.name]);c.valueElem&&d(c.valueElem).val(e);c.textElem?d(c.textElem).val(f):d(a).val(f);d(a).data("value",e);d(a).data("text",f);d(a).data("selectedData",g);c.confirm&&(c.multiple?c.confirm(g,e,f):c.confirm(g[0],e,f))}function p(a){var b=d(a).data("skyTree").data("options");a=d(a).data("selectedData")||[];b.multiple||(a=a[0]||{});return a}
function h(a,b){a=d(a).data("skyTree");var c=a.data("options");a="tree_"+a.attr("id");b=null==b?"":b+"";var e=d.fn.zTree.getZTreeObj(a);b=b.split(c.separator);d.each(b,function(a,b){a=e.getNodeByParam(c.tree.idKey,b,null);c.multiple?e.checkNode(a,!0,!0):e.selectNode(a,!0,!0)})}function m(a,b){var c=d(a).data("skyTree").data("options"),e=d(a).parent();c.disabled=b;d(a).addClass("skydisabled").prop("disabled","disabled");e.find(".openBtn").removeClass("primary").unbind("click.skyTree");b||(d(a).removeClass("skydisabled").removeProp("disabled").removeAttr("disabled"),
e.find(".openBtn").addClass("primary").bind("click.skyTree",function(){n(a)}))}function q(a,b){var c=layer.load(1,{shade:[.1,"#fff"]}),e=d(a).data("skyTree"),f=e.data("options");f.data=b;e="tree_"+e.attr("id");!f.autoComplete||f.multiple||f.gridMode||d(a).skyAutoComplete("setSource",b);var g=d.fn.zTree.getZTreeObj(e);g&&g.destroy();g={data:{key:{name:"name"},simpleData:{enable:!0,idKey:"",pIdKey:"",rootPId:0}},view:{dblClickExpand:!1,selectedMulti:!1},check:{enable:!1},callback:{onClick:null,onDblClick:null,
onCheck:null}};f.tree.name&&(g.data.key.name=f.tree.name);f.tree.idKey&&(g.data.simpleData.idKey=f.tree.idKey);f.tree.pIdKey&&(g.data.simpleData.pIdKey=f.tree.pIdKey);f.tree.rootPId&&(g.data.simpleData.rootPId=f.tree.rootPId);f.multiple?(g.check.enable=!0,g.view.selectedMulti=!0,g.callback.onClick=function(a,c,b){d.fn.zTree.getZTreeObj(c).checkNode(b,!0,!0)},g.callback.onCheck=function(a,c,b){a=d.fn.zTree.getZTreeObj(c);b.checked&&a.checkNode(b,!0,!0)}):(g.callback.beforeClick=function(a,b,c){return!(b.isParent&&
!f.returnLeaf)},g.check.enable=!1,g.view.selectedMulti=!1,g.callback.onDblClick=function(b,c,e){if(!e.isParent||f.returnLeaf)l(a),layer.close(d(a).data("index"))});d.fn.zTree.init(d("#"+e),g,b);f.expand&&(g=d.fn.zTree.getZTreeObj(e),g.expandAll(!0));layer.close(c)}function r(a,b){var c=layer.load(1,{shade:[.1,"#fff"]}),e=[];d.ajax({url:a,data:b,async:!1,type:"POST",dataType:"json",success:function(a){e=a}});layer.close(c);return e}d.fn.skyTree=function(a,b){return"string"==typeof a?d.fn.skyTree.methods[a](this,
b):this.each(function(){var b=d(this).data("skyTree");if(b){b=b.data("options");if(a.url||!d.isEmptyObject(b.param)){var e;if(!(e=a.url!=b.url)){a:{e=a.param;var f=b.param,g=Object.getOwnPropertyNames(e),k=Object.getOwnPropertyNames(f);if(g.length!=k.length)e=!1;else{for(k=0;k<g.length;k++){var h=g[k];if(e[h]!==f[h]){e=!1;break a}}e=!0}}e=!e}e&&(a.data=r(a.url,a.param))}d.extend(b,a)}else a=d.extend({},d.fn.skyTree.defaults,a),a.url&&(a.data=r(a.url,a.param)),b=t(this,a),d(this).data("skyTree",b);
a.data&&q(this,a.data);m(this,a.disabled)})};d.fn.skyTree.methods={loadData:function(a,b){return a.each(function(){q(this,b)})},disable:function(a){return a.each(function(){m(this,!0)})},enable:function(a){return a.each(function(){m(this,!1)})},getValueData:function(a){return p(a[0])},getValue:function(a,b){var c=a[0];if(b)if(a=p(c),e.multiple){for(var e=d(c).data("skyTree").options,c="",f=0;f<a.length;f++)c+=a[f][b]+e.separator,f!=a.length&&(c=c.substring(0,c.lastIndexOf(e.separator)));b=c}else b=
a[b]||"";else b=d(c).data("value")||"";return b},setValue:function(a,b){return a.each(function(){h(this,b)})}};d.fn.skyTree.defaults={title:"\u9009\u62e9\u6846",width:"400px",height:"500px",url:"",param:{},valueElem:"",textElem:"",autoComplete:!1,displayText:[],separator:",",disabled:!1,expand:!0,data:[],multiple:!1,returnLeaf:!1,gridMode:!1,tree:{name:"name",idKey:"id",pIdKey:"parent",rootPId:0},confirm:function(a){},cancel:function(){}}})(jQuery);