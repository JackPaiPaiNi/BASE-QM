/**
 * 
 * 信息管理部软件开发科Bootstrap插件系列
 * 
 * jquery.sky.skyFile html5文件上传美化
 * 
 * jquery.sky.uploader html5文件上传插件 基于layer
 * 
 * jquery.importFile 文件导入组件 基于layer jquery.sky.skyFile
 * 
 * jquery.fn.getUpfileListHtml 获取附件列表html，去掉删除按钮。与jquery.sky.uploader配套使用
 * 
 * jquery.fn.setUpfileListDelete 给附件列表设置删除按钮。与jquery.sky.uploader配套使用
 * 
 * 王歌 2016年12月
 */
(function(a){function f(b,c){c.multiple&&a(b).prop("multiple","multiple");a(b).prop("accept",t(c.fileTypeExts).join(","));var d='<input class="form-control skyFileInput '+("large"==c.size?"input-large":"")+'" type="text">',e='<span class="input-group-btn"><a class="btn btn-info skyFileBtn">'+c.text+"</a></span>",g=d+e;"left"==c.position&&(g=e+d);c.skyUploader?a(b).after(g):(a(b).wrap("<div></div>"),a(b).after('<div class="input-group '+("large"==c.size?"":"input-group-sm")+'">'+g+"</div>"));d=a(b).parent();
a(b).hide();d.data("options",c);return d}function k(b){var c=a(b).data("skyFile"),d=c.data("options");c.find("*").unbind(".skyFile");c.find(".skyFileBtn,.skyFileInput").bind("click.skyFile",function(){c.find("input[type='file']").trigger("click")});c.find("input[type='file']").bind("change.skyFile",function(){var e=a(this)[0].files,g="";if(0==e.length)return!1;d.multiple&&1!=e.length?1<e.length&&(g=e.length+" \u4e2a\u6587\u4ef6\u5df2\u9009\u62e9"):(g=a(this).val().split("\\"),g=g[g.length-1]);c.find(".skyFileInput").val(g);
if(d.skyUploader){var g=a(b).data("skyFile").data("options"),n="",h=t(g.fileTypeExts);if(0<h.length)for(var f=0,k=e.length;f<k;f++){var m=e[f];if(parseInt(l(m.size,!0))<=g.fileSizeLimit){if(!(0<=a.inArray("*",h)||0<=a.inArray(m.name.split(".").pop(),h))){n='\u6587\u4ef6 "'+m.name+'" \u7c7b\u578b\u4e0d\u5141\u8bb8\uff01\u53ea\u5141\u8bb8\u4e0a\u4f20'+g.fileTypeExts;break}}else{n='\u6587\u4ef6 "'+m.name+'" \u5927\u5c0f\u8d85\u8fc7'+g.fileSizeLimit+"KB\uff01";break}}if(""!=n)layer.alert(n,{shadeClose:!0,
title:"\u63d0\u793a",icon:2}),p(b);else for(u(b),f=0,k=e.length;f<k;f++)e[f].index=f,e[f].status=0,q(b,e[f])}})}function u(b){var c=a(b).data("skyUploader"),d=c.data("options"),c={id:"layer_"+c.attr("id"),type:1,title:d.title,closeBtn:0,area:["600px","400px"],content:c,success:function(c,d){a(b).data("index",d)},end:function(){a(b).removeData("index")},btn:["\u786e\u5b9a","\u53d6\u6d88"],yes:function(a,c){m(b)&&layer.close(a)},btn2:function(a,c){p(b)},cancel:function(){p(b)}};layer.open(c);a(d.fileList).css({height:"auto",
"min-height":"28px"});0==a(d.fileList).find(".upfile-list").length&&a(d.fileList).append('<ul class="upfile-list"></ul>')}function q(b,c){var d=a(b).data("skyUploader");d.data("options");var e=a('<tr fileID="${fileID}" class="skyuploader-queue-item"><td><div class="progress progress-striped progress-mini skyuploader-progress"><div class="progress-bar progress-bar-default skyuploader-progress-bar" style="width: 0%;"></div></div>${fileName}</td><td>${fileSize}</td><td class="uploadedsize">\u4e0a\u4f20\u4e2d</td><td><a class="btn btn-minier btn-danger delfilebtn" href="javascript:void(0);"><i class="fa fa-remove"></i></a></td></tr>'.replace(/\${fileID}/g,
c.index).replace(/\${fileName}/g,c.name).replace(/\${fileSize}/g,l(c.size)).replace(/\${fileSize}/g,l(c.size)));e.find(".delfilebtn").on("click.skyUploader",function(){var d=a(b).data("skyFile").find("input[type='file']")[0].files,e=a(b).data("skyUploader");e.data("options");for(var h=0,f=d.length;h<f;h++)if(d[h].index==c.index){e.find("[fileID="+c.index+"]").remove();break}});d.find(".skyuploader-queue").append(e);v(b,c)}function l(b,a){return b=1048576<b&&!a?(Math.round(100*b/1048576)/100).toString()+
"MB":(Math.round(100*b/1024)/100).toString()+"KB"}function t(a){var b=[];a=a.split(",");for(var d=0,e=a.length;d<e;d++)b.push(a[d].split(".").pop());return b}function m(b){var c=a(b).data("skyFile").find("input[type='file']")[0].files,d=a(b).data("skyUploader").data("options");d.multiple||a(d.fileList).find(".upfile-list").empty();for(var e=!0,g=0,f=c.length;g<f;g++){var h=c[g];if(0==h.status||1==h.status){e=!1;break}else 2==h.status&&(h=h.result,"SUCCESS"==h.status&&(h=a('<li><a href="javascript:void(0);" onclick="javascript:window.location.href=encodeURI(\''+
h.downloadurl+'\');"><i class="fa fa-file-archive-o"></i> '+h.filename+'</a><a class="upfile-delete" href="javascript:void(0);"><i class="fa fa-remove"></i></a></li>'),h.find(".upfile-delete").click(function(){a(this).parent().remove()}),a(d.fileList).find(".upfile-list").append(h)))}e?p(b):layer.alert("\u6587\u4ef6\u672a\u4e0a\u4f20\u5b8c\u6bd5\uff01",{shadeClose:!0,title:"\u63d0\u793a",icon:0});return e}function p(b){var c=a(b).data("skyFile");a(b).data("skyUploader").find(".skyuploader-queue").empty();
c.find("input[type='file']").val("");c.find(".skyFileInput").val("")}function v(b,c){var d=a(b).data("skyUploader");b=d.data("options");var e=null;try{e=new XMLHttpRequest}catch(n){e=ActiveXobject("Msxml12.XMLHTTP")}if(e.upload&&(e.upload.onprogress=function(a){var b=d.find("[fileID="+c.index+"] .skyuploader-progress");a=(a.loaded/a.total*100).toFixed(2)+"%";b.children(".skyuploader-progress-bar").css("width",a)},e.onreadystatechange=function(a){if(4==e.readyState){a=d.find("[fileID="+c.index+"]");
if(200==e.status)a.find(".skyuploader-progress-bar").css("width","100%"),c.status=2,c.result=JSON.parse(e.responseText),setTimeout(function(){d.find("[fileID="+c.index+"] .skyuploader-progress").remove()},1E3);else{c.status=3;var b={status:"ERROR"};b.msg=e.responseText;c.result=b}"SUCCESS"!=c.result.status?(a.find(".uploadedsize").html("\u5931\u8d25"),a.closest("tr").attr("title",c.result.msg)):a.find(".uploadedsize").html("\u6210\u529f");d.find(".skyuploader-file").val("")}},0===c.status)){c.status=
1;e.open("post",b.url,!0);e.setRequestHeader("X-Requested-With","XMLHttpRequest");var g=new FormData;g.append(b.fileObjName,c);if(b.formData)for(key in b.formData)g.append(key,b.formData[key]);e.send(g)}}function r(b,c){var d=a(b).data("skyFile");d.data("options").disabled=c;d.find("*").unbind(".skyFile");d.find(".skyFileBtn").prop("disabled","disabled");d.find(".skyFileFile").val("").prop("disabled","disabled");c||(d.find(".skyFileBtn,.skyFileFile").removeProp("disabled").removeAttr("disabled"),
k(b))}a.fn.skyUploader=function(b,c){return"string"==typeof b?a.fn.skyUploader.methods[b](this,c):this.each(function(){var c=a(this).data("skyUploader");if(c)c=c.data("options"),a.extend(c,b);else{b=a.extend(!0,{},a.fn.skyUploader.defaults,b);var e=a.extend(!0,{},a.fn.skyFile.defaults,{text:b.text,multiple:b.multiple,fileTypeExts:b.fileTypeExts,fileSizeLimit:b.fileSizeLimit,disabled:b.disabled,skyUploader:!0}),c=b,g=(new Date).getTime(),g=a('<div id="'+g+'" class="wrapper wrapper-content animated fadeInRight" style="display:none;"></div>').appendTo("body");
g.append('<div class="ibox m-t"><div class="ibox-content no-padding"><table class="table table-hover"><thead><tr><th>\u6587\u4ef6</th><th style="width:100px;">\u5927\u5c0f</th><th style="width:60px;">\u72b6\u6001</th><th style="width:60px;">\u64cd\u4f5c</th></tr></thead><tbody class="skyuploader-queue"></tbody></table></div></div>');g.data("options",c);c=g;a(this).data("skyUploader",c);c=f(this,e);a(this).data("skyFile",c);k(this)}r(this,e.disabled)})};a.fn.skyUploader.methods=
{disable:function(a){return a.each(function(){r(this,!0)})},enable:function(a){return a.each(function(){r(this,!1)})}};a.fn.skyUploader.defaults={title:"\u6587\u4ef6\u4e0a\u4f20",fileList:null,text:"\u8bf7\u9009\u62e9\u6587\u4ef6",fileTypeExts:"*.*",url:"",multiple:!0,disabled:!1,formData:null,fileObjName:"file",fileSizeLimit:102400};a.fn.skyFile=function(b){return this.each(function(){b=a.extend(!0,{},a.fn.skyFile.defaults,b);var c=f(this,b);a(this).data("skyFile",c);k(this)})};a.fn.skyFile.defaults=
{text:"\u8bf7\u9009\u62e9\u6587\u4ef6",size:"small",position:"right",fileTypeExts:"*.*",fileSizeLimit:102400,multiple:!1,skyUploader:!1,disabled:!1}})(jQuery);
jQuery.extend({importFile:function(a){a=$.extend(!0,{title:"\u6587\u4ef6\u5bfc\u5165",url:"",param:{},templateUrl:"",confirm:function(a){}},a);var f=$('<div class="wrapper wrapper-content animated fadeInRight" style="display:none;"><p><input type="file" name="file"><p></div>').appendTo("body");f.find("input[type=file]").skyFile({size:"large",position:"left",fileTypeExts:"*.xls,*.xlsx"});""!=a.templateUrl&&(f.prepend('<p><button class="btn btn-primary btn-xs btn-outline btn_download"><i class="fa fa-file-excel-o"></i>&nbsp;\u6a21\u677f\u4e0b\u8f7d</button><span class="text-primary">\u8bf7\u786e\u8ba4\u5bfc\u5165\u6570\u636e\u683c\u5f0f\u4e0e\u6a21\u677f\u4e00\u81f4!</span></p>'),
f.find(".btn_download").click(function(){window.location.href=encodeURI(a.templateUrl)}));layer.open({type:1,title:a.title,area:["400px"],content:f,end:function(){f.remove()},btn:["\u786e\u5b9a","\u53d6\u6d88"],btn1:function(k,u){var q=layer.load(1,{shade:[.1,"#fff"]}),l=new FormData;l.append("file",f.find("input[type=file]")[0].files[0]);a.param&&$.each(a.param,function(a,f){l.append(a,f)});layer.close(k);setTimeout(function(){$.ajax({url:a.url,type:"POST",data:l,async:!1,cache:!1,contentType:!1,
processData:!1,dataType:"json",complete:function(a,f){layer.close(q)},success:function(f){a.confirm&&a.confirm(f)}})},2E3)}})}});jQuery.fn.extend({getUpfileListHtml:function(){var a=$(this).clone();a.find(".upfile-delete").remove();var f=a.html();a.remove();return f},setUpfileListDelete:function(){var a=$(this).find(".upfile-list");$.each(a.find("li"),function(a,k){$(k).append('<a class="upfile-delete" href="javascript:void(0);"><i class="fa fa-remove"></i></a>')});a.find(".upfile-delete").click(function(){$(this).parent().remove()})}});